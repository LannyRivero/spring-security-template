name: CI Pipeline

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§± Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: ðŸ§© Build and verify
        run: mvn -B clean verify

      - name: ðŸ§¹ Run Checkstyle
        run: mvn -q checkstyle:check

      - name: ðŸŽ¨ Run Spotless
        run: mvn -q spotless:check

      - name: ðŸ§ª Run tests
        run: mvn -q test

      - name: ðŸ“Š Generate Jacoco coverage report
        if: success()
        run: mvn -q jacoco:report

      - name: ðŸ“¦ Build Docker image
        env:
          IMAGE_NAME: spring-security-template
        run: |
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "Building image for owner: $OWNER"
          docker build -t ghcr.io/${OWNER}/${IMAGE_NAME}:${{ github.sha }} .
