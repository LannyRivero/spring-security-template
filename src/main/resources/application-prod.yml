# ================================================================
# üöÄ SPRING SECURITY TEMPLATE - PRODUCTION CONFIGURATION
# ================================================================

# =============================
# üóÑÔ∏è DATASOURCE (PostgreSQL)
# =============================
spring:
  datasource:
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:spring_security_prod}
    username: ${DB_USER}
    password: ${DB_PASSWORD}
    driver-class-name: org.postgresql.Driver
    hikari:
      minimum-idle: 5
      maximum-pool-size: 15
      idle-timeout: 30000
      max-lifetime: 1800000
      connection-timeout: 30000

  jpa:
    hibernate:
      ddl-auto: validate
    open-in-view: false
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: false

  sql:
    init:
      mode: never

  flyway:
    enabled: true
    baseline-on-migrate: true
    validate-on-migrate: true
    locations:
      - classpath:db/migration

  data:
    redis:
      host: ${REDIS_HOST}
      port: ${REDIS_PORT}
      timeout: 2000

# =============================
# ‚öôÔ∏è SERVER
# =============================
server:
  port: ${PORT:8080}
  forward-headers-strategy: framework
  error:
    include-message: never
    include-binding-errors: never
    include-stacktrace: never

# =============================
# üîê JWT / SECURITY (RSA ¬∑ MULTI-KID)
# =============================
security:
  jwt:
    provider: nimbus
    key-provider: keystore
    algorithm: RSA

    issuer: security-template
    access-audience: access-service
    refresh-audience: refresh-service

    access-ttl: PT1H
    refresh-ttl: P7D
    allowed-clock-skew-seconds: 60

    rotate-refresh-tokens: true
    max-active-sessions: 1

    # ------------------------------------------------
    # üîë KEY ROTATION (ENTERPRISE)
    # ------------------------------------------------
    active-kid: prod-rsa-2024
    verification-kids:
      - prod-rsa-2023
      - prod-rsa-2024

    keystore:
      path: ${KEYSTORE_PATH:/opt/keys/security-template.p12}
      type: ${KEYSTORE_TYPE:PKCS12}
      password: ${KEYSTORE_PASSWORD}
      key-password: ${KEY_PASSWORD}

      # kid ‚Üí alias mapping
      kid-alias:
        prod-rsa-2023: jwt-key-2023
        prod-rsa-2024: jwt-key-2024

# =============================
# üö¶ RATE LIMITING (STRICT)
# =============================
rate-limiting:
  enabled: true
  strategy: IP_USER
  max-attempts: 3
  window: 60
  block-seconds: 600
  retry-after: 60
  login-path: /api/v1/auth/login

# =============================
# üåê CORS (RESTRICTED)
# =============================
cors:
  enabled: true
  allow-credentials: true
  allowed-origins:
    - https://app.security-template.com
  allowed-methods:
    - GET
    - POST
    - PUT
    - DELETE
  allowed-headers:
    - Content-Type
    - Authorization
    - X-Requested-With
    - X-Correlation-Id
  exposed-headers:
    - Authorization
    - X-Correlation-Id
  max-age-seconds: 3600

# =============================
# üßæ LOGGING
# =============================
logging:
  level:
    root: WARN
    org.springframework.security: INFO
    org.hibernate.SQL: WARN
    com.lanny.spring_security_template: INFO

# =============================
# üìà ACTUATOR / METRICS
# =============================
management:
  endpoints:
    web:
      exposure:
        include:
          - health
          - info
          - prometheus
  endpoint:
    health:
      show-details: never
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: spring-security-template

