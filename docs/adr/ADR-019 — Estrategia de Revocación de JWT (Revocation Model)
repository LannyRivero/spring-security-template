# ADR-019 â€” Estrategia de RevocaciÃ³n de JWT (Revocation Model)
ğŸ“… Fecha: 2025-11-17  
ğŸ“ Estado: Aprobado

---

## ğŸ¯ Contexto

Los JWT son **stateless**, lo que significa que:

- Una vez emitidos, no pueden invalidarse por sÃ­ mismos  
- El servidor no mantiene estado  
- No existe una â€œsesiÃ³nâ€ que pueda cerrarse manualmente  
- Si el token se filtra, es vÃ¡lido hasta su expiraciÃ³n

Por tanto, se necesita un mecanismo de **revocaciÃ³n** cuando:

- Se elimina un usuario  
- Se bloquea un usuario  
- Se rota el refresh token  
- Se detecta un uso indebido  
- Un usuario cierra sesiÃ³n manualmente  

---

## ğŸ§  DecisiÃ³n

Se implementa una **blacklist estructurada**, con niveles:

---

### 1ï¸âƒ£ Blacklist de Refresh Tokens (persistente o in-memory)

Cuando un refresh token sea usado:

- Se invalida el anterior
- Se aÃ±ade a la blacklist
- El nuevo refresh token es el Ãºnico vÃ¡lido

Esto soporta:

- Refresh Token Rotation  
- Logout seguro  
- Cierre de sesiones  

---

### 2ï¸âƒ£ Blacklist por Usuario

Cuando un usuario sea:

- Eliminado  
- Bloqueado  
- Cambiado de rol  

Se invalidan todos sus tokens mediante las claim:

- `sub`
- `jti`

Esto permite revocar todos los tokens antiguos sin almacenar cada token.

---

### 3ï¸âƒ£ TTL automÃ¡tico de entradas invÃ¡lidas

Las entradas expiran automÃ¡ticamente al alcanzar la fecha `exp`.

---

## âœ” Razones principales

### 1. Modelo escalable  
No requiere almacenar cada access token.

### 2. Seguridad real  
Si un refresh token se filtra â†’ queda invalidado al rotarse.

### 3. Control granular  
Permite revocar por usuario, refresh o token especÃ­fico.

---

## ğŸ§© Alternativas consideradas

### 1. No usar blacklist  
âœ— Inseguro  
âœ— Refresh token reuse attack  

### 2. Guardar todos los access tokens  
âœ— Alto costo  
âœ— No escalable  

### 3. Revocar solo por usuario  
âœ— Insuficiente ante ataques con refresh token  

---

## ğŸ“Œ Consecuencias

### Positivas
- RevocaciÃ³n efectiva  
- Compatible con Refresh Rotation  
- Seguridad avanzada  

### Negativas
- Requiere almacenamiento para blacklist en prod (Redis recomendado)  

---

## ğŸ“¤ Resultado

El sistema implementa una revocaciÃ³n JWT moderna:

- Refresh tokens rotados  
- Blacklist administrada  
- RevocaciÃ³n rÃ¡pida por usuario/jti  

Compatible con modelos enterprise.
